name: Batch Embeddings

on:
  schedule:
    # Run daily at 3 AM UTC (refresh job embeddings)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      limit:
        description: 'Number of jobs to process'
        required: false
        default: '500'
        type: string
      force:
        description: 'Force refresh all embeddings'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  compute-embeddings:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup environment
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
          echo "DIRECT_URL=${{ secrets.DIRECT_URL }}" >> .env
          echo "NODE_ENV=production" >> .env
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}

      - name: Run database migrations
        run: npm run db:push

      - name: Compute batch embeddings
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            LIMIT=${{ github.event.inputs.limit }}
            FORCE=${{ github.event.inputs.force }}
          else
            LIMIT=500
            FORCE=false
          fi
          
          if [ "$FORCE" = "true" ]; then
            npx tsx server/services/batch-embedding.service.ts --force
          else
            npx tsx server/services/batch-embedding.service.ts
          fi
        env:
          BATCH_LIMIT: ${{ github.event.inputs.limit || '500' }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

      - name: Report results
        if: always()
        run: |
          echo "Batch embedding computation completed"
          echo "Check logs above for details"
